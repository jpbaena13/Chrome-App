define([WEBROOT_URL+"js/modules/noteboard.js",WEBROOT_URL+"js/core/sandbox.js"],function(a,b){function c(){}function d(){d.prototype.strokeBegin=function(a,b){c.prototype.strokeBegin.call(this),this.prevX=a,this.prevY=b,this.path.push({x:a,y:b})},d.prototype.strokeMove=function(a,b){c.prototype.strokeMove.call(this),this.context.moveTo(this.prevX,this.prevY),this.context.lineTo(a,b),this.context.strokeStyle=this.brushColor,this.context.stroke(),this.prevX=a,this.prevY=b,this.path.push({x:a,y:b})}}function e(){e.prototype.strokeBegin=function(a,b){c.prototype.strokeBegin.call(this),this.prevX=a,this.prevY=b,this.path.push({x:a,y:b})},e.prototype.strokeMove=function(a,b){c.prototype.strokeMove.call(this),this.context.moveTo(this.prevX,this.prevY),this.context.clearRect(a,b,this.brushSize,this.brushSize),this.context.stroke(),this.prevX=a,this.prevY=b,this.path.push({x:a,y:b})}}var f=void 0,g=function(){a.scribble=!1,f=this,f.sandbox=new b(f),f.sandbox.on("scribble-add",h),f.sandbox.on("scribble-clear",i),f.sandbox.on("scribble-load",j),f.sandbox.on("noteboardTool-eraser-dbclick",i),f.sandbox.on("noteboardTool-pencil",k),f.sandbox.on("noteboardTool-eraser",l),f.sandbox.on("noteboardTool-color-change",m),f.scribble=$("<canvas>").appendTo(a.target).untScribble()},h=function(a){a.realTime&&f.scribble.data("scribble").add(a)},i=function(a){(void 0==a||a.realTime)&&f.scribble.data("scribble").clear(),a||f.sandbox.emit("scribble-clear",{})},j=function(a){a.forEach(function(a){f.scribble.data("scribble").add(a)})},k=function(){var b=$(".button.color").find(".selected").css("background-color");f.scribble.data("scribble").update({brushColor:b,brush:d,brushSize:5}),a.scribble=!0},l=function(){f.scribble.data("scribble").update({brushColor:"eraser",brush:e,brushSize:40}),a.scribble=!0},m=function(a){f.scribble.data("scribble").update({brushColor:a}),$(".button.color").find(".selected").css("background-color",a)};return c.prototype={_init:function(a,b,c){this.context=a,this.context.globalCompositeOperation="source-over",this.brushSize=b,this.brushColor=c,this.draw=!1,this.active=!1,this.path=[],this.realTime=!1},strokeBegin:function(){a.scribble&&(this.active=!0,this.context.beginPath(),this.context.lineWidth=this.brushSize)},strokeMove:function(){this.draw=this.active},strokeEnd:function(){if(this.active=!1,this.realTime)this.realTime=!1,this.path=[];else{var b={brushSize:this.brushSize,brushColor:this.brushColor,path:JSON.stringify(this.path),noteboardId:a.id};this.path=[],f.sandbox.emit("scribble-add",b)}return this.draw?(this.draw=!1,!0):!1}},d.prototype=new c,e.prototype=new c,function(b){var c={width:300,height:250,backgroundColor:"transparent",backgroundImage:!1,backgroundImageX:0,backgroundImageY:0,saveMimeType:"image/png",brush:d,brushSize:5,brushColor:"rgb(0,0,0)",fillOnClear:!0,initContent:[]},f=function(d,e){var f=b(d),g=this,h=f.is("canvas"),i=h?f[0]:document.createElement("canvas"),j=i.getContext("2d"),k=f.innerWidth(),l=f.innerHeight();b.extend(c,e),h?(k=f.parent().width(),l=f.parent().height()):f.append(i),2>k&&(k=c.width),2>l&&(l=c.height),g.blank=!0,g.canvas=i,g.canvas.width=k,g.canvas.height=l,g.clear(),g.brush=new c.brush,g.brush._init(j,c.brushSize,c.brushColor),g.brush.strokeBegin&&g.brush.strokeMove&&g.brush.strokeEnd&&(i.addEventListener("touchstart",function(b){if(b.preventDefault(),b.touches.length>0){var c=(b.touches[0].pageX-f.offset().left)/a.scale,d=(b.touches[0].pageY-f.offset().top)/a.scale;g.brush.strokeBegin(c,d)}},!1),i.addEventListener("touchmove",function(b){if(b.preventDefault(),b.touches.length>0&&g.brush.active){var c=(b.touches[0].pageX-f.offset().left)/a.scale,d=(b.touches[0].pageY-f.offset().top)/a.scale;g.brush.strokeMove(c,d)}},!1),i.addEventListener("touchend",function(a){a.preventDefault(),0==a.touches.length&&(g.blank=!g.brush.strokeEnd()&&g.blank)},!1),b(i).on("mousedown",function(b){var c=(b.pageX-f.offset().left)/a.scale,d=(b.pageY-f.offset().top)/a.scale;g.brush.strokeBegin(c,d)}).on("mousemove",function(b){if(g.brush.active){var c=(b.pageX-f.offset().left)/a.scale,d=(b.pageY-f.offset().top)/a.scale;g.brush.strokeMove(c,d)}}).on("mouseup",function(){g.brush.active&&(g.blank=!g.brush.strokeEnd()&&g.blank)}).on("mouseout",function(){g.brush.active&&(g.blank=!g.brush.strokeEnd()&&g.blank)})),g.init()};f.prototype={init:function(){var a=this;0!=c.initContent.length&&(c.initContent.forEach(function(b){a.brush.strokeMove(b.x,b.y)}),a.blank=!a.brush.strokeEnd()&&a.blank)},clear:function(){var a=this.canvas.getContext("2d"),b=this.canvas.width,d=this.canvas.height;return a.clearRect(0,0,b,d),c.fillOnClear&&(a.fillStyle=c.backgroundColor,a.fillRect(0,0,b,d)),this.blank=!0,this},add:function(b){var c=this,f=JSON.parse(b.path),g="eraser"==c.brush.brushColor?e:d,h=c.brush.brushColor,i=c.brush.brushSize;if(b.brushSize!=c.brush.brushSize||b.brushColor!=c.brush.brushColor){var j="eraser"==b.brushColor?e:d;c.update({brush:j,brushColor:b.brushColor,brushSize:b.brushSize})}var k=a.scribble;a.scribble=!0;var l=f.shift();c.brush.strokeBegin(l.x,l.y),f.forEach(function(a){c.brush.strokeMove(a.x,a.y)}),c.brush.realTime=!0,c.blank=!c.brush.strokeEnd()&&c.blank,(i!=c.brush.brushSize||h!=c.brush.brushColor)&&c.update({brush:g,brushColor:h,brushSize:i}),a.scribble=k},update:function(a,d){var e=!!a.backgroundColor,f=!!a.backgroundImage,g=!!a.width,h=!!a.height,i=!!a.brush;b.extend(c,a);var j=this.canvas.getContext("2d");return i&&(this.brush=new c.brush),this.brush._init(j,c.brushSize,c.brushColor),g&&(this.canvas.width=c.width),h&&(this.canvas.height=c.height),(e||f||g||h||d)&&this.clear(),f&&(addImage(j),this.blank=!1),this}},b.fn.untScribble=function(a){return this.each(function(){b.data(this,"scribble")||b.data(this,"scribble",new f(this,a))})}}(jQuery),{init:g}});