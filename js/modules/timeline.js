define([WEBROOT_URL+"js/modules/noteboard.js",WEBROOT_URL+"js/core/sandbox.js"],function(a,b){var c=void 0,d=function(){c=this,c.sandbox=new b(c),c.elems={},c.position=1,c.ArrowsEnabled=!1,c.playing=!1,c.sandbox.on("resource-index-timeline",j),c.sandbox.on("resource-loaded",k),c.sandbox.on("window-keyup",l),c.sandbox.on("noteboardTool-timeline",f),c.left=void 0,c.top=void 0,c.height=void 0,c.width=void 0,c.elems.timeline=$("<div>",{id:"timeline",Class:"timeline"}).selectable({filter:"",cancel:".untResource",start:function(b){c.left=(b.pageX-a.target.offset().left)/a.scale,c.top=(b.pageY-a.target.offset().top)/a.scale},stop:function(b){var d=(b.pageX-a.target.offset().left)/a.scale,f=(b.pageY-a.target.offset().top)/a.scale;c.width=Math.abs(c.left-d),c.height=Math.abs(c.top-f),c.left=Math.min(d,c.left),c.top=Math.min(f,c.top),c.width>10&&c.height>10&&e()}}).disableSelection().appendTo(a.target),h(),g(),a.showArea=i,a.inactiveTimeline=g},e=function(){var b={};b.bg="transp",b.fs="frame",b.ff="frame",b.msg=a.areas.length+1,b.h=c.height,b.l=c.left,b.t=c.top,b.w=c.width,a.createResource(b)},f=function(){c.elems.timeline.show(),c.elems.container.show(),c.elems.buttons.show(),c.sandbox.emit("timeline-show"),$("#timelinePanel").data("jsp").reinitialise()},g=function(){c.elems.timeline.hide(),c.elems.container.hide(),c.elems.buttons.hide(),c.sandbox.emit("timeline-hide")},h=function(){c.elems.container=$("<div>",{id:"timelinePanel"}).appendTo(a.target.parent()),c.elems.timelinePanel=$("<ul>").appendTo(c.elems.container).sortable({stop:function(a,b){var c=b.item.index()+1,d=b.item.data("model");d.data.msg!=c&&d.setIndexTimeline({index:c})}}).disableSelection(),c.elems.container.jScrollPane({showArrows:!1,maintainPosition:!0,stickToBottom:!0}),c.elems.buttons=$("<div>",{id:"timelineButtons"}).appendTo(a.target.parent()),c.elems.posNumber=$("<input>",{Class:"timelineNumber",type:"text"}).appendTo(c.elems.buttons).val(c.position).on("change",function(){var b=a.areas.length,d=this.value<1?1:this.value>b?b:this.value,e=a.areas[d-1];i(e.model),c.position=d,c.elems.posNumber.val(c.position)}),c.elems.btnLeft=$("<div>",{Class:"icon-arrow-left untBtnZoom",title:i18n.backTime}).prependTo(c.elems.buttons).on("click",function(){c.position--;var b=Math.max(c.position,1),d=a.areas[b-1];i(d.model),c.position=b,c.elems.posNumber.val(c.position)}).qtip({position:{my:"top right"}}),c.elems.btnRight=$("<div>",{Class:"icon-arrow-right untBtnZoom",title:i18n.nextTime}).prependTo(c.elems.buttons).on("click",function(){c.position++;var b=Math.min(c.position,a.areas.length),d=a.areas[b-1];i(d.model),c.position=b,c.elems.posNumber.val(c.position)}).qtip({position:{my:"top right"}}),c.elems.play=$("<div>",{Class:"timelinePlay icon-play",title:i18n.playTimeline}).prependTo(c.elems.buttons).qtip({position:{my:"top right"}}).on("click",function(){fullScreen(),c.elems.container.toggle(c.playing),c.elems.timeline.toggle(c.playing),c.ArrowsEnabled=!c.playing,c.elems.buttons.css("bottom",c.playing?"265px":"30px"),$("#previewer").toggle(c.playing),c.playing||i(a.areas[0].model),c.playing=!c.playing})},i=function(b){var d=window.innerWidth,e=window.innerHeight-50,f=d/e,g=b.data.w/b.data.h;if(a.target.css("transition","1s linear").css("transition-property","left,top"),g>f){a.zoom(d/b.data.w);var h=(e-b.data.h*a.scale)/2;a.target.offset({left:-b.data.l*a.scale,top:-b.data.t*a.scale+50+h})}else{a.zoom(e/b.data.h);var i=(d-b.data.w*a.scale)/2;a.target.offset({left:-(b.data.l*a.scale)+i,top:-b.data.t*a.scale+50})}c.sandbox.emit("noteboard-drag"),c.elems.container.find(".selected").removeClass("selected"),c.elems.container.find("ul li:eq("+(b.data.msg-1)+")").addClass("selected"),c.position=b.data.msg,setTimeout(function(){a.target.css("transition","none")},1e3)},j=function(b){b.realTime&&a.getModel(b.id).setIndexTimeline(b)},k=function(){for(var a=$("#timelinePanel ul li").length,b=[],c=0;a>c;c++){var d=$("#timelinePanel ul li:eq("+c+")");b[d.attr("index")-1]=d}b.forEach(function(a){a.appendTo($("#timelinePanel ul"))}),b[0]&&b[0].addClass("selected")},l=function(a,b){c.ArrowsEnabled&&(37==b?c.elems.btnLeft.click():39==b?c.elems.btnRight.click():27==b&&c.elems.play.click())};return{init:d}});