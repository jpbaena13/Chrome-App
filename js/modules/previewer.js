define([WEBROOT_URL+"js/modules/noteboard.js",WEBROOT_URL+"js/core/sandbox.js"],function(a,b){var c=void 0,d=function(){c=this,c.sandbox=new b(c),c.ration=20,c.sandbox.on("window-resize",f),c.sandbox.on("noteboard-drag",f),c.sandbox.on("noteboard-mousewheel",f),c.sandbox.on("resource-add",e),c.sandbox.on("resource-id",k),c.sandbox.on("resource-move",g),c.sandbox.on("resource-resize",h),c.sandbox.on("resource-bg",i),c.sandbox.on("resource-remove",j),c.sandbox.on("line-add",l),c.sandbox.on("timeline-show",m),c.sandbox.on("timeline-hide",n),c.preview=$("<div>",{id:"previewer"}),c.previewDrag=$("<div>",{Class:"untPreviewDrag"}),c.preview.append(c.previewDrag).appendTo(a.target.parent());var d=a.target.width(),o=a.target.height(),p=void 0,q=void 0;d>o?(p=200,q=o/d*200):(p=d/o*200,q=200),c.preview.css({width:p,height:q});var r=$(window),s=p*r.width()/d,t=q*r.height()/o;c.ration=d/p,c.previewDrag.css({width:s,height:t,left:window.scrollX/c.ration,top:window.scrollY/c.ration}).draggable({containment:"parent",start:function(){a.target.offset({top:50,left:0}),f()},drag:function(a,b){var d=b.helper.outerWidth(),e=b.helper.outerHeight(),f=c.preview.width(),g=c.preview.height();b.position.left=Math.max(Math.min(b.position.left,f-d),0),b.position.top=Math.max(Math.min(b.position.top,g-e),0);var h=b.position.left*c.ration,i=b.position.top*c.ration;c.sandbox.emit("preview-drag",{left:h,top:i})}})},e=function(a){var b=$("<div>").css({height:a.data.h/c.ration,left:a.data.l/c.ration+"px",position:"absolute",top:a.data.t/c.ration+"px",width:a.data.w/c.ration}).data("bg",a.data.bg).addClass("untPreviewNote "+a.data.bg).attr("data-prev-id",a.data.id);"image"==a.data.fs&&b.css({"background-image":"url("+BLOB_IMAGES+a.data.msg+")","background-size":"100% 100%"}),"circle"==a.data.fs&&b.css("border-radius","50%"),c.preview.append(b)},f=function(){var b=a.target.offset().left,d=a.target.offset().top,e=a.target.width(),f=a.target.height(),g=window.innerWidth,h=window.innerHeight;c.previewDrag.css(b>=0?{left:0,width:(g-b)/c.ration/a.scale}:b+e*a.scale<g?{left:(c.preview.width()-(b+e)/c.ration)/a.scale,width:c.preview.width()-(c.preview.width()-(b+e)/c.ration)/a.scale}:{left:-b/c.ration/a.scale,width:g/c.ration/a.scale}),c.previewDrag.css(d>=0?{height:(h-d)/c.ration/a.scale,top:0}:d+f*a.scale<h?{height:c.preview.height()-(c.preview.height()-(d+f)/c.ration)/a.scale,top:(c.preview.height()-(d+f)/c.ration)/a.scale}:{height:h/c.ration/a.scale,top:-d/c.ration/a.scale}),$(".untNoteComment").qtip("reposition")},g=function(a){var b=this;a.notes.forEach(function(a){$("[data-prev-id="+a.id+"]",b.preview).css({left:a.left/c.ration,top:a.top/c.ration})})},h=function(a){var b=this;a.notes.forEach(function(a){$("[data-prev-id="+a.id+"]",b.preview).css({width:a.width/c.ration,height:a.height/c.ration})})},i=function(a){var b=this;a.notes.forEach(function(a){var c=$("[data-prev-id="+a.id+"]",b.preview),d=c.data("bg");c.removeClass(d).addClass(a.bg).data("bg",a.bg)})},j=function(a){var b=this;a.notes.forEach(function(a){$("[data-prev-id="+a.id+"]",b.preview).remove()})},k=function(a){var b=this;$("[data-prev-id="+a.id+"]",b.preview).attr("data-prev-id",a.newId)},l=function(a,b){var d=$("<div>",{Class:"untLinePreview"});d.css("top"==b?{top:a.top/c.ration,width:c.preview[0].offsetWidth,position:"absolute"}:{left:a.left/c.ration,height:c.preview[0].offsetHeight,position:"absolute"}),c.preview.append(d)},m=function(){$(".transp",c.preview).show()},n=function(){$(".transp",c.preview).hide()};return{init:d}});