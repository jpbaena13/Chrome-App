define([WEBROOT_URL+"js/modules/noteboard.js",WEBROOT_URL+"js/core/sandbox.js"],function(a,b){var c=void 0,d=function(){c=this,c.sandbox=new b(c),c.sandbox.on("noteboard-dblclick",e),c.sandbox.on("noteboard-drop",C),c.sandbox.on("resource-load",r),c.sandbox.on("window-keyup",E),c.sandbox.on("resource-add",f),c.sandbox.on("resource-move",g),c.sandbox.on("resource-resize",h),c.sandbox.on("resource-msg",i),c.sandbox.on("resource-back",k),c.sandbox.on("resource-forward",j),c.sandbox.on("resource-bg",l),c.sandbox.on("resource-ff",m),c.sandbox.on("resource-fs",n),c.sandbox.on("resource-c",o),c.sandbox.on("resource-remove",p),c.sandbox.on("resource-downloadImage",z),c.sandbox.on("resource-previewImage",A),c.sandbox.on("resource-comment-add",q),c.sandbox.on("resource-loaded",B),c.sandbox.on("note-attach-add",s),c.sandbox.on("note-attach-remove",t),c.sandbox.on("resource-note",e),c.sandbox.on("resource-image",v),c.sandbox.on("resource-video",w),c.sandbox.on("resource-circle",x),c.sandbox.on("resource-comment",y),u(),a.createResource=e},e=function(b){var c=void 0;switch(b.fs){case"circle":c=new CircleResource(b,a);break;case"image":c=new ImageResource(b,a);break;case"youtube":c=new VideoResource(b,a);break;case"frame":c=new FrameResource(b,a);break;case"comment":c=new CommentResource(b,a);break;default:c=new NoteResource(b,a)}},f=function(a){a.data.realTime&&e(a.data)},g=function(b){b.realTime&&b.notes.forEach(function(b){a.getModel(b.id).setPosition(b.left,b.top)})},h=function(b){b.realTime&&b.notes.forEach(function(b){a.getModel(b.id).setSize(b.width,b.height)})},i=function(b){b.realTime&&a.getModel(b.id).setMsg(b)},j=function(b){b.realTime&&a.getModel(b.id).incrementIndex(b)},k=function(b){b.realTime&&a.getModel(b.id).decrementIndex(b)},l=function(b){b.realTime&&b.notes.forEach(function(b){b.realTime=!0,a.getModel(b.id).setBG(b)})},m=function(b){b.realTime&&b.notes.forEach(function(b){b.realTime=!0,a.getModel(b.id).setFF(b)})},n=function(b){b.realTime&&b.notes.forEach(function(b){b.realTime=!0,a.getModel(b.id).setFS(b)})},o=function(b){b.realTime&&b.notes.forEach(function(b){b.realTime=!0,a.getModel(b.id).setC(b)})},p=function(b){b.realTime&&b.notes.forEach(function(b){b.realTime=!0,a.getModel(b.id).remove(b)})},q=function(b){b.realTime&&a.getModel(b.noteId).addComment(b)},r=function(b){for(var d=0,f=b.length;f>d;d++)b[d].isNew=!1,e(b[d]),a.minIndex>b[d].index&&(a.minIndex=b[d].index),a.maxIndex<b[d].index&&(a.maxIndex=b[d].index);$(".untMainContent").find(".untLoader").remove(),c.sandbox.emit("resource-loaded")},s=function(a){var b=$("[data-id="+a.noteId+"]"),c=b.data("attach")||[];c.push(a),b.data("attach",c),b.find(".icon-attachment").show()},t=function(a){var b=$("[data-id="+a.noteId+"]"),c=b.data("attach"),c=jlinq.from(c).equals("name",a.name).removed();b.data("attach",c),c.length||b.find(".icon-attachment").hide()},u=function(){$(document).on("click",".dz-view",function(){var a=$(this).parent(),b=a.data("attach"),c="https://docs.google.com/viewer?url=https://unnotestorage.blob.core.windows.net/files/"+b,d=800,e=600,f=screen.width/2-d/2,g=screen.height/2-e/2;window.open(c,"Ideozone","toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=0,resizable=0,width="+d+",height="+e+",top="+g+",left="+f)}),$(document).on("click",".dz-remove",function(){var b=$(this).parent(),d=b.data("attach");b.find(".dz-view").hide(),b.find(".dz-download").hide(),b.find(".dz-remove").hide(),$.ajax({url:API+"Files/",type:"DELETE",data:{noteboardId:a.id,attach:d},success:function(a){b.addClass("dz-error").find(".dz-error-message").html(i18n.attachDeleted),b.find(".dz-view").remove(),b.find(".dz-download").remove(),b.find(".dz-remove").remove(),c.sandbox.emit("note-attach-remove",a)},error:function(){b.find(".dz-view").show(),b.find(".dz-download").show(),b.find(".dz-remove").show()}})}),$(document).on("click",".dz-download",function(){var a=$(this),b=a.parent(),c=b.data("attach"),d=$("<iframe>",{src:API+"Files/Download/"+c}).css("display","none");d.appendTo($("body")).load(function(){var a=this.contentDocument||this.contentWindow.document,b=a.getElementsByTagName("pre")[0].innerHTML;b=$.parseJSON(b),validateData(b)})}),$(document).on("click",".dz-delete",function(){$(this).parent().remove()})},v=function(b){var c=b.l,d=b.t;$.untInputWin({content:views.formUploadImage(c,d,a.id),classes:"dropzone",width:"90%"}),new Dropzone("#uploadDropzone",{previewTemplate:views.attachFileBlock(),maxFilesize:2,maxFiles:1,acceptedFiles:"image/*",success:function(a,b){untInputWinRemove(),e(b)},error:function(a,b){var c=$(a.previewElement);return c.find(".dz-download").remove(),c.find(".dz-remove").remove(),c.find(".dz-delete").css("display","block"),c.find(".dz-error-message").html(b),a.previewElement.classList.add("dz-error")}}).on("maxfilesexceeded",function(a){this.removeFile(a)})},w=function(b){$field=$("<input>",{type:"text",id:"videoURL"}).attr("placeholder",i18n.addVideoMsg),$.untInputWin({title:"Insertar Video",content:$field,width:400,clickAccept:function(){var c={},d=$field.val(),f=youtubeID(d);return f?(d="https://www.youtube.com/embed/"+f,c.bg="gray",c.c="000000",c.fs="youtube",c.ff="youtube",c.h=350,c.id="t"+a.autoincrement(),c.l=b.l,c.msg=d,c.t=b.t,c.w=450,c.index=200,c.isNew=!0,c.realTime=!1,void e(c)):($.untInputWin({title:i18n.incorrectYoutubeURL,content:i18n.incorrectYoutubeURLMsg}),!1)}})},x=function(a){var b={l:a.l,t:a.t,c:"circle",ff:"circle",fs:"circle"};e(b)},y=function(a){var b={l:a.l,t:a.t,ff:"comment",fs:"comment",w:40,h:30};e(b)},z=function(a){var b=$("<iframe>",{src:API+"Files/Download/"+$("#n-"+a.id).data("imageName")+"?image=1"}).css("display","none");b.appendTo($("body")).load(function(){var a=this.contentDocument||this.contentWindow.document,b=a.getElementsByTagName("body")[0].innerHTML;b=$.parseJSON(b),validateData(b.msg,i18n.errFileDownload,i18n.errFileDownloadMsg)})},A=function(a){$.untInputWin('<img class="untWinImage" src="'+CDN_IMAGES+$("#n-"+a.id).data("imageName")+'">'),untInputWinCenter()},B=function(){var b=window.location.hash.split("&")[0],d=$(b);if(0!=d.length){var e=(a.target.width(),a.target.height(),window.innerWidth,window.innerHeight,d.position().top),f=d.position().left;a.moveNoteboard({left:f-20,top:e-20});var g=null,h=d.css("box-shadow");!function i(){d.css("box-shadow","0px 0px 20px yellow"),g=setTimeout(function(){d.css("box-shadow","none"),g=setTimeout(function(){i()},500)},500)}(),setTimeout(function(){clearTimeout(g),d.css("box-shadow",h)},3e3),c.sandbox.emit("noteboard-drag"),"comment"==window.location.hash.split("&")[1]&&d.find(".untNoteComment").css("display","block").click()}},C=function(a){var b=a.originalEvent.dataTransfer.getData("Text"),c=youtubeID(b),d=imagePattern.test(b);if(c&&D.video(a,c),d){b=b.split("?")[0];var e=b.substring(0,4);"http"!=e&&(b="http://"+b),D.image(a,b)}},D={video:function(b,c){var d="https://www.youtube.com/embed/"+c,f={};f.bg="gray",f.c="000000",f.fs="youtube",f.ff="youtube",f.h=350,f.id="t"+a.autoincrement(),f.l=(b.originalEvent.pageX-a.target.offset().left)/a.scale,f.msg=d,f.t=(b.originalEvent.pageY-a.target.offset().top)/a.scale,f.w=450,f.index=200,f.isNew=!0,f.realTime=!1,e(f)},image:function(b,c){var d=(b.originalEvent.pageX-a.target.offset().left)/a.scale,f=(b.originalEvent.pageY-a.target.offset().top)/a.scale,g=$("<img>",{src:WEBROOT_URL+"img/default/loader.gif",width:"30px",height:"30px"}).appendTo(a.target).css("position","absolute").css("left",d).css("top",f);$.ajax({url:ROOT_URL+"Files/ImageURL",data:{noteboardId:a.id,left:d,top:f,url:c},type:"POST",dataType:"JSON",success:function(a){e(a),g.remove()}})}},E=function(b,c){if(a.selectedNotes.length>1)if(76==c){var d=a.selectedNotes[0].data.l;a.selectedNotes.forEach(function(a){a.setPosition(d,a.data.t)}),a.selectedNotes[0].dropping()}else if(82==c){var d=a.selectedNotes[0].data.l,e=a.selectedNotes[0].data.w;a.selectedNotes.forEach(function(a){var b=d-(a.data.w-e);a.setPosition(b,a.data.t)}),a.selectedNotes[0].dropping()}else if(84==c){var f=a.selectedNotes[0].data.t;a.selectedNotes.forEach(function(a){a.setPosition(a.data.l,f)}),a.selectedNotes[0].dropping()}else if(66==c){var f=a.selectedNotes[0].data.t,g=a.selectedNotes[0].data.h;a.selectedNotes.forEach(function(a){var b=f-(a.data.h-g);a.setPosition(a.data.l,b)}),a.selectedNotes[0].dropping()}else 46==c&&a.selectedNotes[0].remove({})};return{init:d}});