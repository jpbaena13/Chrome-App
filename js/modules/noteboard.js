"use strict";define([WEBROOT_URL+"js/core/sandbox.js"],function(a){var b,c,d,e,f=void 0,g=function(g){f=this,f.sandbox=new a(this),f.elems={},f.parentId=f.target.data("parentid"),f.scale=1,f.auto_increment=0,f.user=g.noteboard.user,f.permissions=g.noteboard.owner||g.noteboard.shared,f.collaborators=g.noteboard.collaborators,f.readyFunctions=[],f.states={POINTER:1,MOVE:2,ZOOM:3,PENCIL:4,ERASER:5,TIMELINE:6},f.state=f.states.POINTER,f.sandbox.on("window-keydown",j),f.sandbox.on("window-keypress",k),f.sandbox.on("window-click",o),f.sandbox.on("noteboard-mousedown",l),f.sandbox.on("noteboard-mouseup",m),f.sandbox.on("noteboard-mousewheel",n),f.sandbox.on("preview-drag",q),f.sandbox.on("note-lock",u),f.sandbox.on("note-unlock",w),f.sandbox.on("noteboardTool-pointer",A.pointer),f.sandbox.on("noteboardTool-move",A.move),f.sandbox.on("noteboardTool-select",A.select),f.sandbox.on("noteboardTool-zoom",A.zoom),f.sandbox.on("noteboardTool-pencil",A.pencil),f.sandbox.on("noteboardTool-eraser",A.eraser),f.sandbox.on("noteboardTool-timeline",A.timeline),$(window).on("resize",function(a){f.sandbox.emit("window-resize",a)}).on("keydown",function(a){var b=a.keyCode||a.which;return f.sandbox.emit("window-keydown",a,b),!a.ctrlKey||187!=b&&189!=b?void 0:!1}).on("keyup",function(a){var b=a.keyCode||a.which;f.sandbox.emit("window-keyup",a,b)}).on("keypress",function(a){var b=a.keyCode||a.which;f.sandbox.emit("window-keypress",a,b)}).on("click",function(a){f.sandbox.emit("window-click",a)}).on("scroll",function(a){f.sandbox.emit("window-scroll",a)}),f.target.on("dblclick",function(a){if(f.state==f.states.POINTER){var b={l:(a.pageX-f.target.offset().left)/f.scale,t:(a.pageY-f.target.offset().top)/f.scale};f.sandbox.emit("noteboard-dblclick",b)}}).on("mousedown",function(a){f.sandbox.emit("noteboard-mousedown",a)}).on("mouseup",function(a){f.sandbox.emit("noteboard-mouseup",a)}).on("mousewheel",function(a){f.sandbox.emit("noteboard-mousewheel",a)}).on("drop",function(a){a.preventDefault(),a.stopPropagation(),f.sandbox.emit("noteboard-drop",a)}).on("dragover",function(a){a.preventDefault(),a.stopPropagation()}).on("dragleave",function(a){a.preventDefault(),a.stopPropagation()}).draggable({drag:function(a,b){f.sandbox.emit("noteboard-drag",a,b)},stop:function(a,b){f.sandbox.emit("noteboard-drag",a,b)},disabled:!0}).selectable({distance:1,filter:"",cancel:".untResource",start:function(a){b=(a.pageX-f.target.offset().left)/f.scale,c=(a.pageY-f.target.offset().top)/f.scale,a.shiftKey||s()},stop:function(a){var g=(a.pageX-f.target.offset().left)/f.scale,h=(a.pageY-f.target.offset().top)/f.scale;switch(d=Math.abs(b-g),e=Math.abs(c-h),b=Math.min(g,b),c=Math.min(h,c),f.state){case f.states.POINTER:x(a);break;case f.states.ZOOM:y()}}}),f.target.parent().on("mousewheel",function(a){f.sandbox.emit("noteboard-mousewheel",a)}),void 0!=g.noteboard.user.id&&(f.instance=new Noteboard(g.noteboard,!0),h(),i()),f.ready(function(){var a=f.target.width(),b=f.target.height(),c=window.innerWidth,d=window.innerHeight,e=(a-c)/2,g=(b-d)/2;q({left:e,top:g}),f.sandbox.emit("noteboard-drag")})},h=function(){f.elems.container=$("<div>",{id:"noteboardToolbar"}).appendTo($(".untMainContent")),f.elems.subcontainer=$("<div>",{Class:"subcontainer"}).appendTo(f.elems.container),f.elems.pointer=$("<div>",{Class:"button singleton pointer selected",title:i18n.pointerTool}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",function(){f.sandbox.emit("noteboardTool-pointer")}),f.elems.move=$("<div>",{Class:"button singleton move",title:i18n.moveTool}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",function(){f.sandbox.emit("noteboardTool-move")}),f.elems.zoom=$("<div>",{Class:"button singleton zoom",title:i18n.zoomTool}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",function(){f.sandbox.emit("noteboardTool-zoom")});var a=!1,b=function(){a?(f.elems.hideResource.removeClass("hide-resource-off selected"),$(".untResource").show()):(f.elems.hideResource.addClass("hide-resource-off selected"),$(".untResource").hide()),a=!a};f.elems.hideResource=$("<div>",{Class:"button hide-resource-on",title:i18n.hideResourceTool}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",b),f.elems.subcontainer.append($("<div>",{Class:"line"})),f.elems.pencil=$("<div>",{Class:"button singleton pencil",title:i18n.pencilTool}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",function(){f.sandbox.emit("noteboardTool-pencil")}),f.elems.eraser=$("<div>",{Class:"button singleton eraser",title:i18n.eraserTool}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",function(){f.sandbox.emit("noteboardTool-eraser")}).on("dblclick",function(){f.sandbox.emit("noteboardTool-eraser-dbclick")});var c=$("<div>",{id:"colors"}),d={red:$("<div>",{Class:"red"}),orange:$("<div>",{Class:"orange"}),yellow:$("<div>",{Class:"yellow"}),green:$("<div>",{Class:"green"}),blue:$("<div>",{Class:"blue"}),white:$("<div>",{Class:"white"}),black:$("<div>",{Class:"black"})};$.each(d,function(a,b){b.appendTo(c),b.on("click",function(){f.sandbox.emit("noteboardTool-color-change",a),f.sandbox.emit("noteboardTool-pencil")})}),f.elems.color=$("<div>",{Class:"button color"}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{event:"click"},hide:{event:"unfocus"},content:c}).html('<div class="selected"></div>'),f.elems.subcontainer.append($("<div>",{Class:"line"})),f.elems.slides=$("<div>",{Class:"button singleton slides",title:i18n.timelineTool}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",function(){f.sandbox.emit("noteboardTool-timeline")}),f.elems.Screen=$("<div>",{Class:"untHideScreen"}).appendTo($("body")).draggable({axis:"y"});var e=!1,g=function(){e?(f.elems.Screen.hide(),$(this).removeClass("selected")):(f.elems.Screen.show(),$(this).addClass("selected")),e=!e};f.elems.screenHide=$("<div>",{Class:"button screen-hide",title:i18n.screenHide}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",g),f.elems.subcontainer.append($("<div>",{Class:"line"})),f.elems.export=$("<div>",{Class:"button export",title:i18n.exportTool}).appendTo(f.elems.subcontainer).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).on("click",function(){var a=$("<iframe>",{src:"https://realtime.unnotes.com/Noteboard/ExportImage/"+$("#noteboard").data("url")+"/BaukdCsQnZvNUT6tzhhN2DPQAEv9dTc8Ppf5b9BPBhJG64XRQqNuP7ATR6r2bnKnUA4G3YgVfRr5Uqu2"}).css("display","none");a.appendTo($("body")).load(function(){var a=this.contentDocument||this.contentWindow.document,b=a.getElementsByTagName("pre")[0].innerHTML;b=$.parseJSON(b),validateData(b)})});var h=!1,i=function(){h?($("#historyContainer").hide(),$(this).removeClass("selected")):($("#historyContainer").show(),$(this).addClass("selected")),h=!h};f.elems.history=$("<div>",{Class:"button history",title:i18n.historyTool}).qtip({position:{my:"bottom center",at:"top center"},show:{delay:1e3}}).appendTo(f.elems.subcontainer).on("click",i),f.elems.subcontainer2=$("<div>",{Class:"subcontainer collaborators"}).appendTo(f.elems.container),$("<div>",{Class:"collaborator icon-plus",title:i18n.addCollaborators}).appendTo(f.elems.subcontainer2).qtip({position:{my:"bottom center",at:"top center"},show:{delay:500}}).on("click",function(){f.instance.view.elems.share.click()}),f.collaborators.forEach(function(a){$("<div>",{Class:"collaborator",title:a.fullname}).appendTo(f.elems.subcontainer2).qtip({position:{my:"bottom center",at:"top center"},show:{delay:500}}).css("background-image","url("+a.profileImage+")").draggable({revert:!0,helper:"clone"})})},i=function(){f.elems.zoomPanel=$("<div>",{id:"zoomToolbar"}).appendTo(f.target.parent()),f.elems.btnZoomin=$("<div>",{Class:"untBtnZoom icon-plus",title:i18n.zoomIn}).appendTo(f.elems.zoomPanel).on("click",function(a){a.originalEvent.deltaY=-1,f.sandbox.emit("noteboard-mousewheel",a,.2)}).qtip({position:{my:"top right"}}),f.elems.btnZoomout=$("<div>",{Class:"untBtnZoom icon-minus",title:i18n.zoomOut}).appendTo(f.elems.zoomPanel).on("click",function(a){a.originalEvent.deltaY=1,f.sandbox.emit("noteboard-mousewheel",a,.2)}).qtip({position:{my:"top right"}}),f.elems.btnZoomFix=$("<div>",{Class:"untBtnZoom icon-contract",title:i18n.zoomFix}).appendTo(f.elems.zoomPanel).on("click",function(a){var b=window.innerWidth-50,c=window.innerHeight-70,d=b/c,e=f.target.width()/f.target.height();if(e>d){r(b/f.target.width());var g=(c-f.target.height()*f.scale)/2;f.target.offset({left:0,top:60+g})}else{r(c/f.target.height());var h=(b-f.target.width()*f.scale)/2;f.target.offset({left:h,top:60})}f.sandbox.emit("noteboard-mousewheel",a)}).qtip({position:{my:"top right"}}),f.elems.btnFullScreen=$("<div>",{Class:"untBtnZoom icon-screen",title:i18n.fullScreen}).appendTo(f.elems.zoomPanel).on("click",function(){fullScreen()}).qtip({position:{my:"top right"}})},j=function(a,b){!a.ctrlKey||187!=b&&189!=b||(a.originalEvent.deltaY=187==b?-1:1,f.sandbox.emit("noteboard-mousewheel",a,.2))},k=function(a){a.keyCode||a.which},l=function(){f.state==f.states.MOVE&&f.target.css("cursor","url("+WEBROOT_URL+"img/noteboard/cursors/hand-close.png),auto")},m=function(){f.state==f.states.MOVE&&f.target.css("cursor","url("+WEBROOT_URL+"img/noteboard/cursors/hand-open.png),auto")},n=function(a,b){var c=1/f.scale;$(".untResource").find(".untNoteResize").css({"-webkit-transform":"scale("+c+")","-moz-transform":"scale("+c+")",transform:"scale("+c+")"}),a&&(b||(b=.02),a.originalEvent.deltaY>0?f.scale>f.minZoom&&(f.scale=Math.round(100*(f.scale-b))/100):f.scale<f.maxZoom&&(f.scale=Math.round(100*(f.scale+b))/100),r(f.scale))},o=function(a){0!=a.button||a.shiftKey||s()},p=function(a){for(var b=this.models.length-1;b>=0;b--)if(this.models[b].data.id==a)return this.models[b]},q=function(a){f.target.offset({left:-a.left*f.scale,top:-a.top*f.scale+50})},r=function(a){a=a<noteboard.minZoom?f.minZoom:a>f.maxZoom?f.maxZoom:a,f.scale=a,f.target.css("-webkit-transform","scale("+f.scale+")"),f.target.css("-moz-transform","scale("+f.scale+")"),f.target.css("transform","scale("+f.scale+")")},s=function(){f.selectedNotes.forEach(function(a){a.trigger("resource-selecting",!1)}),f.selectedNotes=[]},t=function(a){var b={noteId:a.model.data.id,user:f.user};f.sandbox.emit("note-lock",b)},u=function(a){if(a.realTime){var b=f.getModel(a.noteId);b.setLocked(!0,a.user)}},v=function(a){var b={noteId:a.model.data.id};f.sandbox.emit("note-unlock",b)},w=function(a){if(a.realTime){var b=f.getModel(a.noteId);b.setLocked(!1)}},x=function(a){80>d||80>e||f.models.forEach(function(f){f.data.l>b&&f.data.t>c&&f.data.l+f.data.w<b+d&&f.data.t+f.data.h<c+e&&f.selectingResource({shiftKey:a.shiftKey,selecting:!0})})},y=function(){if(d>80&&e>80){var a=window.innerWidth,g=window.innerHeight-50,h=a/g,i=d/e;if(i>h){r(a/d);var j=(g-e*f.scale)/2;f.target.offset({left:-b*f.scale,top:-c*f.scale+50+j})}else{r(g/e);var k=(a-d*f.scale)/2;f.target.offset({left:-(b*f.scale)+k,top:-c*f.scale+50})}f.sandbox.emit("noteboard-mousewheel"),A.pointer()}},z=function(a){switch(f.state){case f.states.POINTER:f.models.forEach(function(a){"frame"!=a.data.ff&&a.setLocked(!0)});break;case f.states.MOVE:f.target.draggable("disable");break;case f.states.PENCIL:case f.states.ERASER:f.scribble=!1,f.target.selectable("enable");break;case f.states.TIMELINE:f.inactiveTimeline&&f.inactiveTimeline()}f.state=a,$(".singleton").removeClass("selected")},A={pointer:function(){f.state!=f.states.POINTER&&(z(f.states.POINTER),f.target.css("cursor","auto"),f.elems.pointer.addClass("selected"),f.models.forEach(function(a){a.setLocked(!1)}))},move:function(){f.state!=f.states.MOVE&&(z(f.states.MOVE),f.target.css("cursor","url("+WEBROOT_URL+"img/noteboard/cursors/hand-open.png),auto"),f.elems.move.addClass("selected"),f.target.draggable("enable"))},zoom:function(){f.state!=f.states.ZOOM&&(z(f.states.ZOOM),f.target.css("cursor","url("+WEBROOT_URL+"img/noteboard/cursors/zoom.png),auto"),f.elems.zoom.addClass("selected"))},pencil:function(){f.state!=f.states.PENCIL&&(z(f.states.PENCIL),f.target.css("cursor","url("+WEBROOT_URL+"img/noteboard/cursors/pencil.png) 5 15,auto"),f.elems.pencil.addClass("selected"),f.target.selectable("disable"))},eraser:function(){f.state!=f.states.ERASER&&(z(f.states.ERASER),f.target.css("cursor","url("+WEBROOT_URL+"img/noteboard/cursors/eraser.png),auto"),f.elems.eraser.addClass("selected"),f.target.selectable("disable"))},timeline:function(){f.state!=f.states.TIMELINE&&(z(f.states.TIMELINE),f.target.css("cursor","auto"),f.elems.slides.addClass("selected"))}};return{id:$("#noteboard").data("noteboardid"),target:$("#noteboard"),selectedNotes:[],areas:[],models:[],minIndex:200,maxIndex:200,minZoom:.28,maxZoom:4,init:g,zoom:r,getModel:p,moveNoteboard:q,unselectResources:s,noteLock:t,noteUnlock:v,ready:function(a){f.readyFunctions.push(a)},autoincrement:function(){return f.auto_increment+=1,f.auto_increment}}});